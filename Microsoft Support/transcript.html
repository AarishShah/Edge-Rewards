<html>

<head>
    <title> Customer Transcript </title>

    <script src="https://cdn.botframework.com/botframework-webchat/4.15.7/webchat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/7.8.0/rxjs.umd.min.js"
        integrity="sha512-v0/YVjBcbjLN6scjmmJN+h86koeB7JhY4/2YeyA5l+rTdtKLv0VbDBNJ32rxJpsaW1QGMd1Z16lsLOSGI38Rbg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"
        integrity="sha256-hNyljag6giCsjv/yKmxK8/VeHzvMDvc5u8AzmRvm1BI=" crossorigin="anonymous"></script>

    <script>
        function shareObservable(observable)
        {
            let observers = [];
            let subscription;

            return new Observable(observer =>
            {
                if (!subscription)
                {
                    subscription = observable.subscribe({
                        complete()
                        {
                            observers.forEach(observer => observer.complete());
                        },
                        error(err)
                        {
                            observers.forEach(observer => observer.error(err));
                        },
                        next(value)
                        {
                            observers.forEach(observer => observer.next(value));
                        }
                    });
                }

                observers.push(observer);

                return () =>
                {
                    observers = observers.filter(o => o !== observer);

                    if (!observers.length)
                    {
                        subscription.unsubscribe();
                        subscription = null;
                    }
                };
            });
        }
    </script>
    <script>
        const messages = [{ "created": "2024-11-13T13:02:27+00:00", "isControlMessage": false, "content": "Just too confirm is this a feedback to the Microsoft team or you are facing any issue with the script?", "contentType": "text", "createdDateTime": "2024-11-13T13:02:27+00:00", "deleted": false, "from": { "user": { "displayName": "Manav", "id": "8:acs:409035c5-b285-4ca4-91cd-2b59eff23943_00000023-75bc-7845-ac00-343a0d00e069" } }, "attachments": [], "id": "1731502947711", "tags": "public", "deliveryMode": "bridged", "isBridged": "True" }, { "created": "2024-11-13T13:01:26+00:00", "isControlMessage": false, "content": "Alright!", "contentType": "text", "createdDateTime": "2024-11-13T13:01:26+00:00", "deleted": false, "from": { "user": { "displayName": "Manav", "id": "8:acs:409035c5-b285-4ca4-91cd-2b59eff23943_00000023-75bc-7845-ac00-343a0d00e069" } }, "attachments": [], "id": "1731502886034", "tags": "public", "deliveryMode": "bridged", "isBridged": "True" }, { "created": "2024-11-13T13:00:58+00:00", "isControlMessage": false, "content": "No, I am not!\n\nThis script exploits the MS Reward. I would like you to report it to the technical team.\n\nThat's it!", "contentType": "text", "createdDateTime": "2024-11-13T13:00:58+00:00", "deleted": false, "from": { "application": { "displayName": "Customer", "id": "8:acs:409035c5-b285-4ca4-91cd-2b59eff23943_00000023-c579-b964-e3c7-593a0d00afbf" } }, "attachments": [], "id": "1731502858689", "deliveryMode": "bridged", "widgetId": "ec57bd88-e4c9-4ca6-af79-846040f9dfb8", "clientActivityId": "hh2m4vbxl4r", "tags": "ChannelId-lcw,FromCustomer" }, { "created": "2024-11-13T12:59:49+00:00", "isControlMessage": false, "content": "Noted", "contentType": "text", "createdDateTime": "2024-11-13T12:59:49+00:00", "deleted": false, "from": { "application": { "displayName": "Customer", "id": "8:acs:409035c5-b285-4ca4-91cd-2b59eff23943_00000023-c579-b964-e3c7-593a0d00afbf" } }, "attachments": [], "id": "1731502789105", "deliveryMode": "bridged", "widgetId": "ec57bd88-e4c9-4ca6-af79-846040f9dfb8", "clientActivityId": "aiwya0q9369", "tags": "ChannelId-lcw,FromCustomer" }, { "created": "2024-11-13T12:59:48+00:00", "isControlMessage": false, "content": "Just to confirm are you facing issue with the rewards on the edge?", "contentType": "text", "createdDateTime": "2024-11-13T12:59:48+00:00", "deleted": false, "from": { "user": { "displayName": "Manav", "id": "8:acs:409035c5-b285-4ca4-91cd-2b59eff23943_00000023-75bc-7845-ac00-343a0d00e069" } }, "attachments": [], "id": "1731502788419", "tags": "public", "deliveryMode": "bridged", "isBridged": "True" }, { "created": "2024-11-13T12:59:27+00:00", "isControlMessage": false, "content": "Please make a note of Case Number -XXXXXXXXXX ,Â  for your future reference which I have created for the current interaction.", "contentType": "text", "createdDateTime": "2024-11-13T12:59:27+00:00", "deleted": false, "from": { "user": { "displayName": "Manav", "id": "8:acs:409035c5-b285-4ca4-91cd-2b59eff23943_00000023-75bc-7845-ac00-343a0d00e069" } }, "attachments": [], "id": "1731502767875", "tags": "public", "deliveryMode": "bridged", "isBridged": "True" }, { "created": "2024-11-13T12:59:11+00:00", "isControlMessage": false, "content": "Thank you for raising this concern, I understand how important it is for you to fix this issue, please be rest assured I will try my best to help you with this issue.", "contentType": "text", "createdDateTime": "2024-11-13T12:59:11+00:00", "deleted": false, "from": { "user": { "displayName": "Manav", "id": "8:acs:409035c5-b285-4ca4-91cd-2b59eff23943_00000023-75bc-7845-ac00-343a0d00e069" } }, "attachments": [], "id": "1731502751478", "tags": "public", "deliveryMode": "bridged", "isBridged": "True" }, { "created": "2024-11-13T12:58:57+00:00", "isControlMessage": false, "content": "The Repository link is: https://github.com/AarishShah/Edge-Rewards", "contentType": "text", "createdDateTime": "2024-11-13T12:58:57+00:00", "deleted": false, "from": { "application": { "displayName": "Customer", "id": "8:acs:409035c5-b285-4ca4-91cd-2b59eff23943_00000023-c579-b964-e3c7-593a0d00afbf" } }, "attachments": [], "id": "1731502737735", "deliveryMode": "bridged", "widgetId": "ec57bd88-e4c9-4ca6-af79-846040f9dfb8", "clientActivityId": "15gxvy6u2ch", "tags": "ChannelId-lcw,FromCustomer" }, { "created": "2024-11-13T12:58:22+00:00", "isControlMessage": false, "content": "Kindly contant me at XXXXXXXXXX@gmail.com instead of phone.\n\nI would like to report an issue that I have a script that let's me run a Python script to collect rewards from Microsoft Edge.", "contentType": "text", "createdDateTime": "2024-11-13T12:58:22+00:00", "deleted": false, "from": { "application": { "displayName": "Customer", "id": "8:acs:409035c5-b285-4ca4-91cd-2b59eff23943_00000023-c579-b964-e3c7-593a0d00afbf" } }, "attachments": [], "id": "1731502702609", "deliveryMode": "bridged", "widgetId": "ec57bd88-e4c9-4ca6-af79-846040f9dfb8", "clientActivityId": "e3k8h1imzv8", "tags": "ChannelId-lcw,FromCustomer" }, { "created": "2024-11-13T12:56:39+00:00", "isControlMessage": false, "content": "Thank you for contacting Microsoft Support. I 'm Manav .\n\n  \n\n\n\nPlease stay active on this chat and respond within 2-3minutes to avoid disconnection. Kindly provide your phone number with the country code so we can reconnect if needed.", "contentType": "text", "createdDateTime": "2024-11-13T12:56:39+00:00", "deleted": false, "from": { "user": { "displayName": "Manav", "id": "8:acs:409035c5-b285-4ca4-91cd-2b59eff23943_00000023-75bc-7845-ac00-343a0d00e069" } }, "attachments": [], "id": "1731502599331", "tags": "public", "deliveryMode": "bridged", "isBridged": "True" }, { "created": "2024-11-13T12:56:22+00:00", "isControlMessage": false, "content": "Manav", "contentType": "text", "createdDateTime": "2024-11-13T12:56:22+00:00", "deleted": false, "from": { "user": { "displayName": "", "id": "8:acs:409035c5-b285-4ca4-91cd-2b59eff23943_00000011-bcdf-e940-99c6-593a0d005978" } }, "attachments": [], "id": "1731502582088", "tags": "system,agentaccepted", "fromUserId": "8:acs:409035c5-b285-4ca4-91cd-2b59eff23943_00000023-c579-b964-e3c7-593a0d00afbf" }, { "created": "2024-11-13T12:56:07+00:00", "isControlMessage": false, "content": "An agent will be with you in a moment.", "contentType": "text", "createdDateTime": "2024-11-13T12:56:07+00:00", "deleted": false, "from": { "user": { "displayName": "", "id": "8:acs:409035c5-b285-4ca4-91cd-2b59eff23943_00000011-bcdf-e940-99c6-593a0d005978" } }, "attachments": [], "id": "1731502567878", "tags": "system,agentassignmentready", "fromUserId": "8:acs:409035c5-b285-4ca4-91cd-2b59eff23943_00000023-c579-b964-e3c7-593a0d00afbf" }, { "created": "2024-11-13T12:55:46+00:00", "isControlMessage": true, "content": "<historydisclosedupdate><eventtime>1731502546083</eventtime></historydisclosedupdate>", "createdDateTime": "2024-11-13T12:55:46+00:00", "deleted": false, "id": "1731502546083" }, { "created": "2024-11-13T12:55:45+00:00", "isControlMessage": true, "content": "<addmember><eventtime>1731502545975</eventtime></addmember>", "createdDateTime": "2024-11-13T12:55:45+00:00", "deleted": false, "id": "1731502545975" }];
        const disableMarkdownMessageFormatting = true;
        const disableNewLineMarkdownSupport = false;
    </script>
    <script>
        class Translator
        {
            static convertTranscriptMessageToActivity(message)
            {
                const { created, OriginalMessageId, id, isControlMessage, content, tags, from, attachments, amsMetadata, amsReferences } = message;

                //it's required to convert the id to a number, otherwise the webchat will not render the messages in the correct order
                // if the OrginalMessageId is not present, we can use the id as the sequence id, which is always present.

                const webchatSequenceId = Translator.convertStringValueToInt(OriginalMessageId) || Translator.convertStringValueToInt(id);

                const activity = {
                    from: {
                        role: 'bot'
                    },
                    type: 'message'
                };

                // Ignore control messages
                if (isControlMessage)
                {
                    return false;
                }

                if (tags)
                {
                    const formattedTags = tags.split(',');

                    // Ignore system message
                    if (formattedTags.includes('system'))
                    {
                        return false;
                    }

                    // Ignore hidden message
                    if (formattedTags.includes('Hidden'))
                    {
                        return false;
                    }
                }

                // Add C1 user display name
                if (from && from.user && from.user.displayName)
                {
                    activity.from.name = from.user.displayName;
                }

                // Add C2 user display name
                if (from && from.application && from.application.displayName && from.application.displayName === 'Customer')
                {
                    activity.from = {
                        role: 'user',
                        name: from.application.displayName
                    };
                }

                // Attachments
                if (amsReferences && amsMetadata)
                {
                    const metadata = JSON.parse(amsMetadata);
                    const { fileName } = metadata[0];
                    const text = `The following attachment was uploaded during the conversation: ${fileName}`;

                    if (message.attachments && message.attachments.length > 0 && message.contentUrl)
                    {
                        activity.attachments = message.attachments;
                        activity.attachments[0].contentUrl = message.contentUrl;
                        activity.attachments[0].thumbnailUrl = message.contentUrl;
                    };

                    return {
                        ...activity,
                        text,
                        timestamp: created,
                        channelData: {
                            "webchat:sequence-id": webchatSequenceId
                        }
                    }
                }

                // Message
                if (content)
                {
                    // Adaptive card formatting
                    if (content.includes('"text"') && content.includes('"attachments"') && content.includes('"suggestedActions"'))
                    {
                        try
                        {
                            const partialActivity = JSON.parse(content);
                            return {
                                ...activity,
                                ...partialActivity,
                                timestamp: created,
                                channelData: {
                                    "webchat:sequence-id": webchatSequenceId
                                }
                            };
                        } catch
                        {

                        }
                    }
                }

                return {
                    ...activity,
                    text: content,
                    timestamp: created,
                    channelData: {
                        "webchat:sequence-id": webchatSequenceId
                    }
                };
            }

            static convertStringValueToInt(value)
            {
                if (typeof value !== "string" || value === "")
                {
                    return undefined;
                }

                const result = parseInt(value);
                return isNaN(result) ? undefined : result;
            }
        }
    </script>
    <script>
        class TranscriptAdapter
        {
            constructor()
            {
                this.connectionStatus$ = new window.rxjs.BehaviorSubject(0); // Uninitialized
                this.activity$ = shareObservable(new Observable((observer) =>
                {
                    this.activityObserver = observer;

                    this.connectionStatus$.next(1); // Connecting
                    this.connectionStatus$.next(2); // Online

                    // Retrieve messages
                    if (messages)
                    {
                        setTimeout(() =>
                        { // setTimeout is needed due to some WebChat issues
                            messages.map((message) =>
                            {
                                this.activityObserver.next({
                                    ...Translator.convertTranscriptMessageToActivity(message),
                                    type: 'message'
                                });
                            });
                        }, 1);
                    }
                }));
            }
        }
    </script>
    <style>
        body {
            margin: 0;
        }

        .message-name {
            font-family: Segoe UI, SegoeUI, Helvetica Neue, Helvetica, Arial, sans-serif;
            font-weight: 700;
            font-size: 10px;
        }

        .message-timestamp {
            font-family: Segoe UI, SegoeUI, Helvetica Neue, Helvetica, Arial, sans-serif;
            font-weight: 500;
            font-size: 10px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            text-align: center;
        }

        .avatar--bot {
            background-color: #2b88d8;
        }

        .avatar--user {
            background-color: #0078d4;
        }

        .avatar>p {
            font-weight: 600;
            text-align: center;
            line-height: 0.5;
            font-family: "Segoe UI", Arial, sans-serif;
        }

        .avatar--bot>p {
            color: #ffffff;
        }

        .avatar--user>p {
            color: #ffffff;
        }

        .webchat__bubble__content>div.ms_lcw_webchat_adaptive_card {
            background-color: #FFF;
        }

        div[class="ac-textBlock"] {
            color: #000 !important;
        }

        .ms_lcw_webchat_received_message a:link,
        .ms_lcw_webchat_received_message a:visited,
        .ms_lcw_webchat_received_message a:hover,
        .ms_lcw_webchat_received_message a:active {
            color: #FFF;
        }
    </style>
</head>


<body>
    <script>
        if (!navigator.onLine)
        {
            const offlineText = `Network Error. Please make sure you are connected to the internet.`;
            document.body.innerHTML = offlineText;
        }

        window.addEventListener("online", () =>
        {
            document.body.innerHTML = `Connection restored. Please refresh the page <button onclick="window.location.reload()"> Refresh </button>`;
        });
    </script>
    <div id="transcript"></div>
    <script>
        const getIconText = (text) =>
        {
            if (text)
            {
                const initials = text.split(/\s/).reduce((response, word) => response += word.slice(0, 1), '');
                if (initials.length > 1)
                {
                    return initials.substring(0, 2).toUpperCase();
                } else
                {
                    return text.substring(0, 2).toUpperCase();
                }
            }

            return "";
        }

        const activityMiddleware = () => (next) => (...args) =>
        {
            const [card] = args;

            if (card.activity)
            {
                if (card.activity.from && card.activity.from.role === "channel")
                {
                    return () => false;
                }

                // Incoming text message
                if (card.activity.text && card.activity.from && card.activity.from.role !== "user")
                {
                    return (...renderArgs) => (React.createElement(
                        'div',
                        { className: 'ms_lcw_webchat_received_message' },
                        next(...args)(...renderArgs)
                    ))
                }
            }

            return next(...args);
        };

        const activityStatusMiddleware = () => (next) => (...args) =>
        {
            const [card] = args;
            const { activity } = card;

            if (activity)
            {
                const { from, timestamp } = activity;

                const nameElement = React.createElement(
                    'span',
                    { className: 'message-name' },
                    from.name
                );

                const formattedDate = new Date(timestamp);
                const formattedTimeString = formattedDate.toLocaleTimeString("en-us", { year: "numeric", month: "numeric", day: "numeric", hour: "2-digit", minute: "2-digit" });

                const timestampElement = React.createElement(
                    'span',
                    { className: 'message-timestamp' },
                    formattedTimeString
                );

                return from.name && timestamp && React.createElement('span', null, nameElement, ' - ', timestampElement)
            }

            return next(...args);
        };

        const avatarMiddleware = () => (next) => (...args) =>
        {
            const [card] = args;
            const { fromUser, activity } = card;
            const initials = getIconText(activity.from.name);

            const avatarElement = React.createElement(
                "div",
                { className: fromUser ? "avatar avatar--user" : "avatar avatar--bot" },
                React.createElement(
                    "p",
                    null,
                    `${initials}`
                )
            );

            return avatarElement;
        }

        const attachmentMiddleware = () => (next) => (...args) =>
        {
            const [card] = args;
            const { activity } = card;

            if (activity)
            {
                const { activity: { attachments }, attachment } = card;

                // No attachment
                if (!attachments || !attachments.length || !attachment)
                {
                    return next(...args);
                }

                let { content, contentType } = attachment || { content: "", contentType: "" };

                // Adaptive card
                if (contentType.startsWith("application/vnd.microsoft.card"))
                {
                    const adaptiveCardElement = React.createElement(
                        "div",
                        { className: 'ms_lcw_webchat_adaptive_card' },
                        next(...args)
                    );

                    return adaptiveCardElement;
                }
            }

            return next(...args);
        }

        const createMarkdown = (disableMarkdownMessageFormatting, disableNewLineMarkdownSupport) =>
        {
            let markdown;
            if (!disableMarkdownMessageFormatting)
            {
                markdown = new window.markdownit(
                    "default",
                    {
                        html: true,
                        linkify: true,
                        breaks: (!disableNewLineMarkdownSupport)
                    }
                );
            } else
            {
                markdown = new window.markdownit(
                    "zero",
                    {
                        html: true,
                        linkify: true,
                        breaks: (!disableNewLineMarkdownSupport)
                    }
                );

                markdown.enable([
                    "entity",
                    "linkify",
                    "html_block",
                    "html_inline",
                    "newline"
                ]);
            }

            return markdown;
        };

        const markdown = createMarkdown(disableMarkdownMessageFormatting, disableNewLineMarkdownSupport);
        const renderMarkdown = (text) =>
        {
            const render = disableNewLineMarkdownSupport ? markdown.renderInline.bind(markdown) : markdown.render.bind(markdown);
            text = render(text);
            return text;
        };

        const adapter = new TranscriptAdapter();
        const styleOptions = {
            hideSendBox: true,
            backgroundColor: '#edebe9',
            bubbleBackground: '#2b88d8',
            bubbleTextColor: '#ffffff',
            bubbleBorderRadius: 12,
            bubbleNubSize: 1,
            bubbleFromUserBackground: '#0078d4',
            bubbleFromUserTextColor: '#ffffff',
            bubbleFromUserBorderRadius: 12,
            bubbleFromUserNubSize: 1,
            botAvatarInitials: 'C1',
            userAvatarInitials: 'C2'
        };

        window.WebChat.renderWebChat({
            directLine: adapter,
            styleOptions,
            activityMiddleware,
            activityStatusMiddleware,
            avatarMiddleware,
            attachmentMiddleware,
            renderMarkdown
        },
            document.getElementById('transcript'));
    </script>
</body>

</html>